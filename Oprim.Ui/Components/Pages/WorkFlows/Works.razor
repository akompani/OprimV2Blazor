@page "/Works"
@using MediatR
@using MudBlazor
@using Oprim.Application.Dtos.PageableParams
@using Oprim.Application.Interfaces
@using Oprim.Application.Patterns.PMO.ProjectItemGroups.Queries.GetProjectItemGroups
@using Oprim.Application.Patterns.WorkFlow.Works.Queries.GetWorks
@using Oprim.Domain.Entities.PMO
@using Oprim.Domain.Entities.WorkFlow
@using Oprim.Ui.Components.Shared.Dialogs.Projects
@rendermode InteractiveServer

<HeadContent>
    <style>
        .mud-input > input.mud-input-root-outlined, div.mud-input-slot.mud-input-root-outlined {
            padding: 10.5px 14px !important;
        }

        .mud-table-pagination {
            display: flex;
            justify-content: center;
        }

        .mud-table-pagination-toolbar {
            border-top: none;
        }

        .mud-dialog .mud-dialog-content {
            padding: 10px !important;
        }

        .mud-dialog .mud-dialog-title {
            padding: 5px 15px !important;
        }
    </style>
</HeadContent>

<MudThemeProvider/>
<MudPopoverProvider/>
<MudDialogProvider/>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <MudPaper Elevation="1" Class="rounded-2xl" Style="box-shadow: none">

        <MudTable Items="@_items"
                  Hover="true"
                  Dense="true"
                  Filter="new Func<ProjectItemGroup,bool>(FilterFunc1)"
                  @bind-SelectedItem="selectedItem1"
                  Class="w-100"
                  Loading="@_loading">

            <LoadingContent>
                <div class="d-flex flex-column align-items-center justify-content-center p-5">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Medium"/>
                    <MudText Typo="Typo.subtitle1" Class="mt-2 text-center text-secondary">
                        در حال بارگذاری داده‌ها...
                    </MudText>
                </div>
            </LoadingContent>

            <ToolBarContent>
                <div>
                    <MudTextField @bind-Value="searchString1"
                                  Placeholder="جستجو..."
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Class="mx-2"
                                  Variant="Variant.Outlined"/>
                </div>

                <MudButton Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           Variant="Variant.Filled"
                           Class="rounded-lg"
                           OnClick="CreateItem">
                    افزودن
                </MudButton>
                <MudSpacer/>
                <MudText Typo="Typo.h6" Class="font-weight-bold">Project Item Group</MudText>
            </ToolBarContent>

            <HeaderContent>
                <MudTh Class="th-mud-table">شماره</MudTh>
                <MudTh Class="th-mud-table">نام گروه</MudTh>
                <MudTh Class="th-mud-table">نام پروژه</MudTh>
                <MudTh Class="th-mud-table">عملیات</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd Class="td-mud-table" DataLabel="کد پروژه">@context.Id</MudTd>
                <MudTd Class="td-mud-table" DataLabel="شماره قرارداد">@context.Name</MudTd>
                <MudTd Class="td-mud-table" DataLabel="نام پروژه">@context.Project.Name</MudTd>
                <MudTd Class="td-mud-table text-nowrap" DataLabel="عملیات">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                   Color="Color.Info"
                                   OnClick="@(() => EditItem(context))"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Color="Color.Error"/>
                </MudTd>
            </RowTemplate>


            <NoRecordsContent>
                <MudText Class="text-right pr-4 my-3" Typo="Typo.body1" Color="Color.Secondary">
                    آیتمی ثبت نشده است.
                </MudText>
            </NoRecordsContent>

            <PagerContent>
                <div class="d-flex flex-column align-center pb-2">
                    <MudPagination ShowFirstButton="false"
                                   Selected="_filter.Page"
                                   ShowLastButton="false"
                                   Count="_filter.TotalPage"
                                   SelectedChanged="OnPageChanged" Class="mt-4"/>
                </div>
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code
{
     [Inject] private IUnitOfWork _ofWork { get; set; } = default!;
    [Inject] private IMediator Mediator { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;
    private string searchString1 = "";
    private Work? selectedItem1;
    private List<Work> _items = [];
    private bool _loading = true; // ← فلگ لودینگ

    private async Task LoadData()
    {
        try
        {
            _loading = true;
            await Task.Delay(100);
            _items = await Mediator.Send(new GetWorksQuery());
            Console.WriteLine(_items.Count);
        }
        finally
        {
            _loading = false;
        }

        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }
    private PageableParam _filter = new PageableParam
    {
        PageSize = 10,
        Page = 1,
        Search = string.Empty,
        TotalPage = 0
    };

    private async Task OnPageChanged(int newPage)
    {
        _filter.Page = newPage;
        await LoadData();
    }
    private async Task CreateItem()
    {
        var parameters = new DialogParameters { ["Item"] = null };
        var dialog = DialogService.Show<WorkDialog>("", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var newItem = (Work)result.Data!;
            await _ofWork.GenericRepository<Work>().AddAsync(newItem, CancellationToken.None);
            _items.Add(newItem);
            await LoadData();
        }
    }

    private async Task EditItem(Work item)
    {
        var parameters = new DialogParameters { ["Item"] = item };
        var dialog = DialogService.Show<WorkDialog>("", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var updated = (Work)result.Data!;
            await _ofWork.GenericRepository<Work>().UpdateAsync(updated, CancellationToken.None);
            var index = _items.FindIndex(x => x.Id == updated.Id);
            if (index >= 0) _items[index] = updated;
            await LoadData();
        }
    }

    private bool FilterFunc1(Work element) =>
        string.IsNullOrWhiteSpace(searchString1) ||
        element.Name.Contains(searchString1, StringComparison.OrdinalIgnoreCase);
}
