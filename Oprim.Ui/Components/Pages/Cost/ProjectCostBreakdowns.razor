@page "/ProjectCostBreakdowns"
@using MediatR
@using Oprim.Application.Interfaces
@using Oprim.Application.Patterns.PMO.Projects.Queries.GetProjects
@using Oprim.Ui.Components.Shared.Dialogs.Projects
@using Oprim.Domain.Entities.Cost
@using Oprim.Application.Patterns.Cost.ProjectCostBreakdowns.Queries.GetProjectCostBreakdowns
@using Oprim.Ui.Components.Shared.Dialogs.ProjectCostBreakdowns
@using MudBlazor

@rendermode InteractiveServer

<HeadContent>
    <style>
        .mud-input > input.mud-input-root-outlined, div.mud-input-slot.mud-input-root-outlined {
            padding: 10.5px 14px !important;
        }

        .mud-table-pagination {
            display: flex;
            justify-content: center;
        }

        .mud-table-pagination-toolbar {
            border-top: none;
        }

        .mud-dialog .mud-dialog-content {
            padding: 10px !important;
        }

        .mud-dialog .mud-dialog-title {
            padding: 5px 15px !important;
        }
    </style>
</HeadContent>
<MudThemeProvider/>
<MudPopoverProvider/>
<MudDialogProvider/>
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <MudPaper Elevation="1" Class="p-4 rounded-2xl" Style="box-shadow: none">

        <MudTable Items="@_items"
                  Hover="true"
                  Dense="true"
                  Filter="new Func<ProjectCostBreakdown,bool>(FilterFunc1)"
                  @bind-SelectedItem="selectedItem1"
                  Class="w-100"
                  Loading="@_loading">

            <LoadingContent>
                <div class="d-flex flex-column align-items-center justify-content-center p-5">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Medium"/>
                    <MudText Typo="Typo.subtitle1" Class="mt-2 text-center text-secondary">
                        در حال بارگذاری داده‌ها...
                    </MudText>
                </div>
            </LoadingContent>

            <ToolBarContent>
                <div>
                    <MudTextField @bind-Value="searchString1"
                                  Placeholder="جستجو..."
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Class="mx-2"
                                  Variant="Variant.Outlined"/>
                </div>

                <MudButton Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           Variant="Variant.Filled"
                           Class="rounded-lg"
                           OnClick="CreateItem">
                    افزودن
                </MudButton>
                <MudSpacer/>
                <MudText Typo="Typo.h6" Class="font-weight-bold">Project Cost Breakdown</MudText>
            </ToolBarContent>

            <HeaderContent>
                <MudTh>شماره</MudTh>
                <MudTh>کد پروژه</MudTh>
                <MudTh>نام</MudTh>
                <MudTh>نام پروژه</MudTh>
                <MudTh>TopLevelId</MudTh>
                <MudTh>EstimateCost</MudTh>
                <MudTh>TotalCost</MudTh>
                <MudTh>تاریخ ایجاد</MudTh>
                <MudTh>عملیات</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd DataLabel="کد پروژه">@context.Id</MudTd>
                <MudTd DataLabel="کد پروژه">@context.Code</MudTd>
                <MudTd DataLabel="شماره قرارداد">@context.Name</MudTd>
                <MudTd DataLabel="نام پروژه">@context.Project.Name</MudTd>
                <MudTd DataLabel="کارفرما">@context.TopLevelId</MudTd>
                <MudTd DataLabel="پیمانکار">@context.EstimateCost.ToString("N0")</MudTd>
                <MudTd DataLabel="تاریخ قرارداد">@context.TotalCost.ToString("N0")</MudTd>
                <MudTd DataLabel="تاریخ قرارداد">@context.CreatePersianTime</MudTd>
                <MudTd DataLabel="عملیات" Class="text-nowrap">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                   Color="Color.Info"
                                   OnClick="@(() => EditItem(context))"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Color="Color.Error"/>
                </MudTd>
            </RowTemplate>


            <NoRecordsContent>
                <MudText Class="text-right pr-4 my-3" Typo="Typo.body1" Color="Color.Secondary">
                    آیتمی ثبت نشده است.
                </MudText>
            </NoRecordsContent>

            <PagerContent>
                <MudTablePager/>
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    [Inject] IUnitOfWork _ofWork { get; set; } = default!;
    [Inject] IMediator Mediator { get; set; } = default!;
    [Inject] IDialogService DialogService { get; set; } = default!;

    private string searchString1 = "";
    private ProjectCostBreakdown? selectedItem1;
    private List<ProjectCostBreakdown> _items = [];
    private bool _loading = true; // ← فلگ لودینگ

    private async Task LoadData()
    {
        try
        {
            _loading = true;
            await Task.Delay(100);
            _items = await Mediator.Send(new GetProjectCostBreakdownsQuery());
            Console.WriteLine(_items.Count);
        }
        finally
        {
            _loading = false;
        }

        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task CreateItem()
    {
        var parameters = new DialogParameters { ["Item"] = null };
        var dialog = DialogService.Show<ProjectCostBreakdownDialog>("", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var newItem = (ProjectCostBreakdown)result.Data!;
            await _ofWork.GenericRepository<ProjectCostBreakdown>().AddAsync(newItem, CancellationToken.None);
            _items.Add(newItem);
            await LoadData();
        }
    }

    private async Task EditItem(ProjectCostBreakdown item)
    {
        var parameters = new DialogParameters { ["Item"] = item };
        var dialog = DialogService.Show<ProjectCostBreakdownDialog>("", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var updated = (ProjectCostBreakdown)result.Data!;
            await _ofWork.GenericRepository<ProjectCostBreakdown>().UpdateAsync(updated, CancellationToken.None);
            var index = _items.FindIndex(x => x.Id == updated.Id);
            if (index >= 0) _items[index] = updated;
            await LoadData();
        }
    }

    private bool FilterFunc1(ProjectCostBreakdown element) =>
        string.IsNullOrWhiteSpace(searchString1) ||
        element.Name.Contains(searchString1, StringComparison.OrdinalIgnoreCase);

}
